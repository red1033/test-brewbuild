#!/usr/bin/perl
use warnings;
use strict;

use Getopt::Long;
use Test::BrewBuild::Tester;

my $ip = '0.0.0.0';
my $port = 7800;
my $help;

if (@ARGV && $ARGV[0] !~ /(?:start|stop)/ || ! @ARGV){
    $help = 1;
}
my $op = shift @ARGV;

GetOptions(
    "ip=s"   => \$ip,
    "port=i" => \$port,
    "help"   => \$help,
);

if ($help){
    print <<'EOF';
Usage: 

bbtester start [--ip 0.0.0.0] [--port 7800]]
bbtester stop

EOF
exit;
}

my $tester = Test::BrewBuild::Tester->new;

$tester->ip($ip);
$tester->port($port);

if ($op eq 'stop'){
    $tester->stop;
    exit;
}
if ($op eq 'start'){
    $tester->start;
}

=pod

=head1 NAME

bbtester - Remote Unix testing platform server daemon for L<Test::BrewBuild>'s
L<brewbuild>.

=head1 SYNOPSIS

Listen for incoming C<brewbuild> build requests on all IPs and port 7800 (TCP)

    bbtester start

Listen using a different IP/Port pair

    bbtester start -i 192.168.10.5 -p 7789

Stop the service from running

    bbtester stop

=head1 DESCRIPTION

This script is the listener end of the distributed C<Test::BrewBuild> testing
environment.

C<bbtester> daemonizes a L<Test::BrewBuild::Tester> object, and listens for
incoming build requests from a test dispatcher.

We then run the appropriate commands, and return the results to the dispatcher
for processing.

=head1 AUTHOR

Steve Bertrand, C<< <steveb at cpan.org> >>

=head1 CONTRIBUTING

Any and all feedback and help is appreciated. A Pull Request is the preferred
method of receiving changes (L<https://github.com/stevieb9/p5-test-brewbuild>),
but regular patches through the bug tracker, or even just email discussions are
welcomed.

=head1 BUGS

L<https://github.com/stevieb9/p5-test-brewbuild/issues>

=head1 SUPPORT

You can find documentation for this script and its associated module with the
perldoc command.

    perldoc bbtester
    perldoc Test::BrewBuild::Tester

=head1 SEE ALSO

    perldoc brewbuild
    perldoc Test::BrewBuild

=head1 LICENSE AND COPYRIGHT

Copyright 2016 Steve Bertrand.

This program is free software; you can redistribute it and/or modify it
under the terms of either: the GNU General Public License as published
by the Free Software Foundation; or the Artistic License.

See L<http://dev.perl.org/licenses/> for more information.

=cut

